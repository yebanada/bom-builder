name: ðŸŒ¸ Bom Builder

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Name'
        required: false
        default: 'Bom'
      website_url:
        description: 'Website URL'
        required: false
        default: ''
      theme_color:
        description: 'Theme Color (hex without #)'
        required: false
        default: 'FF6B9D'
      build_type:
        description: 'Build Type'
        required: true
        default: 'release'
        type: choice
        options:
          - debug
          - release

env:
  DEFAULT_APP_NAME: Bom
  DEFAULT_THEME: FF6B9D

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ðŸ“¥ Checkout repository
      - name: Checkout
        uses: actions/checkout@v4

      # ðŸŒ¸ Bom Brain (Normalize Inputs)
      - name: Bom Brain
        id: bom
        run: |
          APP_NAME="${{ github.event.inputs.app_name }}"
          [ -z "$APP_NAME" ] && APP_NAME="${DEFAULT_APP_NAME}"

          THEME="${{ github.event.inputs.theme_color }}"
          [ -z "$THEME" ] && THEME="${DEFAULT_THEME}"

          URL="${{ github.event.inputs.website_url }}"
          if [ -z "$URL" ]; then
            URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          fi

          VERSION="v$(date +'%Y.%m.%d')-build${{ github.run_number }}"
          PACKAGE="com.bom.$(echo $APP_NAME | tr '[:upper:]' '[:lower:]' | tr ' ' '.' | tr -cd '[:alnum:].')"

          echo "name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "package=$PACKAGE" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "color=$THEME" >> $GITHUB_OUTPUT

          echo "ðŸŒ¸ Building $APP_NAME | $VERSION"

      # â˜• Setup Java
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # ðŸ¤– Setup Android SDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0

      # ðŸ— Create Project Structure
      - name: Create Project Structure
        run: |
          mkdir -p app/src/main/java/com/bom
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/values

      # âš™ Generate Gradle Files
      - name: Generate Gradle Files
        run: |
          cat > build.gradle << 'EOF'
          plugins {
              id 'com.android.application' version '8.2.0' apply false
          }
          EOF

          cat > settings.gradle << 'EOF'
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "Bom"
          include ':app'
          EOF

          cat > gradle.properties << 'EOF'
          org.gradle.jvmargs=-Xmx4096m -Dfile.encoding=UTF-8
          android.useAndroidX=true
          android.nonTransitiveRClass=true
          EOF

          cat > app/build.gradle << EOF
          plugins {
              id 'com.android.application'
          }

          android {
              namespace '${{ steps.bom.outputs.package }}'
              compileSdk 34

              defaultConfig {
                  applicationId "${{ steps.bom.outputs.package }}"
                  minSdk 24
                  targetSdk 34
                  versionCode ${{ github.run_number }}
                  versionName "${{ steps.bom.outputs.version }}"
                  resValue "string", "app_name", "${{ steps.bom.outputs.name }}"
                  resValue "string", "web_url", "${{ steps.bom.outputs.url }}"
              }

              buildTypes {
                  debug {
                      debuggable true
                  }
                  release {
                      minifyEnabled false
                  }
              }

              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
          }

          dependencies {
              implementation 'androidx.appcompat:appcompat:1.6.1'
              implementation 'androidx.webkit:webkit:1.9.0'
          }
          EOF

      # ðŸ“± Create Android App Code
      - name: Generate App Code
        run: |
          cat > app/src/main/java/com/bom/MainActivity.java << 'EOF'
          package com.bom;

          import android.os.Bundle;
          import android.webkit.WebView;
          import androidx.appcompat.app.AppCompatActivity;

          public class MainActivity extends AppCompatActivity {
              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);

                  WebView webView = new WebView(this);
                  setContentView(webView);

                  webView.getSettings().setJavaScriptEnabled(true);
                  webView.loadUrl(getString(R.string.web_url));
              }
          }
          EOF

          cat > app/src/main/res/values/strings.xml << 'EOF'
          <resources>
              <string name="app_name">Bom</string>
              <string name="web_url">https://example.com</string>
          </resources>
          EOF

          cat > app/src/main/AndroidManifest.xml << 'EOF'
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <application
                  android:label="@string/app_name"
                  android:theme="@style/Theme.AppCompat.Light.DarkActionBar">
                  <activity android:name=".MainActivity">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LAUNCHER"/>
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

      # ðŸ”§ Generate Gradle Wrapper
      - name: Generate Gradle Wrapper
        run: |
          gradle wrapper --gradle-version 8.2

      # ðŸ›  Build APK
      - name: Build APK
        run: |
          chmod +x gradlew
          if [ "${{ github.event.inputs.build_type }}" = "debug" ]; then
            ./gradlew assembleDebug
          else
            ./gradlew assembleRelease
          fi

      # ðŸ“¦ Upload APK
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: bom-apk
          path: app/build/outputs/apk/**/*.apk
